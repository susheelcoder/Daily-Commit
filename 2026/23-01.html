<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>AI Video Generator - Fixed Version</title>
    <style>
        :root { --primary: #00f2fe; --bg: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; display: flex; justify-content: center; padding: 20px; }
        .card { background: #1e293b; padding: 30px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; }
        .upload-zone { border: 2px dashed var(--primary); padding: 30px; border-radius: 15px; cursor: pointer; margin-bottom: 20px; }
        #imageUrlOutput { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #334155; background: #000; color: var(--primary); font-size: 11px; }
        .preview-img { width: 100%; max-height: 200px; object-fit: contain; display: none; margin: 15px 0; border-radius: 10px; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-gen { background: var(--primary); color: #0f172a; }
        #status { color: #fbbf24; margin: 10px 0; font-size: 14px; display: none; }
        video { width: 100%; border-radius: 10px; margin-top: 20px; display: none; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <h2>üöÄ AI Video Generator</h2>
    
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <span id="labelText">üìÅ Click to Upload Photo</span>
        <img id="imgPreview" class="preview-img">
    </div>
    <input type="file" id="fileInput" hidden accept="image/*" onchange="uploadImage(this.files[0])">

    <div id="status">‚è≥ Processing...</div>

    <label style="font-size: 12px; color: #94a3b8; display: block; text-align: left;">Generated URL:</label>
    <input type="text" id="imageUrlOutput" placeholder="URL will appear here..." readonly>
    
    <button class="btn-gen" id="genBtn" onclick="startVideoAi()">üé¨ Create AI Video</button>

    <video id="finalVideo" controls autoplay loop></video>
</div>

<script>
    const API_KEY = "C5952036-e030-4e09-af40-fde35b647d91:dbf537440b309a29ec17b45d60975b98";

    // 1. FIXED UPLOAD FUNCTION
    async function uploadImage(file) {
        if (!file) return;

        const status = document.getElementById('status');
        const urlInput = document.getElementById('imageUrlOutput');
        const preview = document.getElementById('imgPreview');
        const label = document.getElementById('labelText');

        status.style.display = "block";
        status.innerText = "Uploading to Cloud...";
        urlInput.value = "Connecting...";

        try {
            // Fal.ai storage requires direct binary body for /storage/upload
            const response = await fetch('https://rest.alpha.fal.ai/storage/upload', {
                method: 'POST',
                headers: { 
                    'Authorization': `Key ${API_KEY}`,
                    'Content-Type': file.type 
                },
                body: file
            });

            const data = await response.json();
            console.log("Upload Success:", data);

            if (data.url) {
                urlInput.value = data.url; // Is baar undefined nahi aayega
                preview.src = data.url;
                preview.style.display = "block";
                label.style.display = "none";
                status.innerText = "‚úÖ Uploaded Successfully!";
            } else {
                throw new Error("URL missing in response");
            }
        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå Upload Error: " + err.message;
            urlInput.value = "Error occurred";
        }
    }

    // 2. VIDEO GENERATION FUNCTION
    async function startVideoAi() {
        const url = document.getElementById('imageUrlOutput').value;
        if (!url || url.includes("Error") || url.includes("Connecting")) {
            return alert("Pehle sahi image upload hone dein!");
        }

        const btn = document.getElementById('genBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "üé¨ AI is working on your video...";
        status.style.display = "block";

        try {
            const response = await fetch('https://queue.fal.run/fal-ai/kling-video/v1.5/standard/image-to-video', {
                method: 'POST',
                headers: { 
                    'Authorization': `Key ${API_KEY}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ 
                    image_url: url, 
                    prompt: "natural cinematic motion, 4k high quality" 
                })
            });

            const queue = await response.json();
            if (queue.request_id) {
                pollResult(queue.request_id);
            } else {
                throw new Error("Request ID not received");
            }
        } catch (e) {
            alert("Video API Error: " + e.message);
            btn.disabled = false;
        }
    }

    // 3. POLLING FOR VIDEO RESULT
    async function pollResult(rid) {
        const status = document.getElementById('status');
        const check = setInterval(async () => {
            try {
                const res = await fetch(`https://queue.fal.run/fal-ai/kling-video/requests/${rid}`, {
                    headers: { 'Authorization': `Key ${API_KEY}` }
                });
                const data = await res.json();
                
                console.log("Status Check:", data.status);

                if (data.status === "COMPLETED") {
                    clearInterval(check);
                    const v = document.getElementById('finalVideo');
                    v.src = data.video.url;
                    v.style.display = "block";
                    status.innerText = "‚úÖ Video Ready!";
                    document.getElementById('genBtn').disabled = false;
                } else if (data.status === "FAILED") {
                    clearInterval(check);
                    status.innerText = "‚ùå Generation Failed";
                    document.getElementById('genBtn').disabled = false;
                }
            } catch (err) {
                console.error("Polling error:", err);
            }
        }, 5000);
    }
</script>

</body>
</html>
