<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>One Page Video Call Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f2f2f2;
    text-align:center;
    padding:20px;
  }
  h2{margin-bottom:10px;}
  .videos{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-top:15px;
  }
  video{
    width:45%;
    background:#000;
    border-radius:10px;
  }
  button{
    padding:10px 18px;
    margin:10px;
    font-size:16px;
    cursor:pointer;
  }
</style>
</head>
<body>

<h2>ðŸŽ¥ One Page WebRTC Call (Test)</h2>
<p>Do alag device / browser tab me open karo</p>

<div class="videos">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
</div>

<button onclick="startCall()">Start Call</button>
<button onclick="joinCall()">Join Call</button>

<script>
/* ðŸ”¥ FIREBASE CONFIG (APNA DALO) */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ðŸ”— WebRTC */
const servers = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

const pc = new RTCPeerConnection(servers);
const roomId = "test-room-1";

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
let localStream;

/* ðŸŽ¤ Camera + Mic */
navigator.mediaDevices.getUserMedia({ video:true, audio:true })
.then(stream=>{
  localStream = stream;
  localVideo.srcObject = stream;
  stream.getTracks().forEach(track => pc.addTrack(track, stream));
})
.catch(err=>alert("Camera/Mic allow karo"));

pc.ontrack = e => {
  remoteVideo.srcObject = e.streams[0];
};

pc.onicecandidate = e => {
  if(e.candidate){
    db.ref(roomId+"/candidates").push(JSON.stringify(e.candidate));
  }
};

/* ðŸ“ž Start Call */
async function startCall(){
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref(roomId+"/offer").set(JSON.stringify(offer));
}

/* ðŸ“ž Join Call */
async function joinCall(){
  db.ref(roomId+"/offer").once("value", async snap=>{
    if(!snap.exists()) return alert("Offer nahi mila");
    const offer = JSON.parse(snap.val());
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    db.ref(roomId+"/answer").set(JSON.stringify(answer));
  });
}

/* ðŸ” Answer Listener */
db.ref(roomId+"/answer").on("value", async snap=>{
  if(snap.exists()){
    const answer = JSON.parse(snap.val());
    if(!pc.currentRemoteDescription){
      await pc.setRemoteDescription(answer);
    }
  }
});

/* â„ ICE Candidates */
db.ref(roomId+"/candidates").on("child_added", snap=>{
  const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
  pc.addIceCandidate(candidate);
});
</script>

</body>
</html>